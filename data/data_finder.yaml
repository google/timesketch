# Config file for analyzing data to detect whether data sources
# are present in the data set or not.
#
# Each analyzer definition in this file defines sets of requirements
# that are needed to determine if a certain type of data is present
# in the sketch. In addition to the parameters given in this definition
# start and end time are defined as parameters to the data analyzer
# to further limit the data set that is searched.
#
# The analyzer is simple, it runs the query, which is defined either as a
# query_string or a query_dsl. Then a particular field or an attribute
# of the resulting data set is fetched and compared against a regular
# expression. If there is a match in the regular expression then a True
# value is returned, and that data is considered to be part of the
# overall dataset for that time period, otherwise False is returned and
# we assume that data is missing from the total dataset.
#
# These are the available fields:
#       description         Simple string that provides a bit more description
#                           of the data that is being analyzed.
#
#       notes               A message that may be displayed to the user if the
#                           data source is not present in the dataset, perhaps
#                           helpful hints on where the data is defined, how to
#                           collect it, or how to add it to Timesketch.
#
#       query_string        A query string (OpenSearch Query String) that
#                           defines the search string that will be used to find
#                           data within the dataset. This is the same search
#                           string as can be found in the Web UI of Timesketch.
#
#       query_dsl           A query DSL (OpenSearch Query DSL) that defines the
#                           full query DSL that is used to find data within the
#                           the dataset. Each data analyzer needs to define
#                           either a query_string or a query_dsl. If both are
#                           defined the query_string is used and query_dsl
#                           is ignored.
#
#       attribute           The attribute or field that will be further
#                           inspected by a regular expression in order to
#                           determine if the data exists within the dataset.
#
#       regular_expression  The regular expression that is run on the data from
#                           the field or the attribute that is fetched from the
#                           the attribute definition.
#
#       re_flags            Each regular expression can define a flag, which is
#                           a list of flags as strings from the re module.
#                           These include:
#                               - DEBUG
#                               - DOTALL
#                               - IGNORECASE
#                               - LOCALE
#                               - MULTILINE
#                               - TEMPLATE
#                               - UNICODE
#                               - VERBOSE
#
#       re_parameters       A regular expression may also contain a variable
#                           that can be replaced by a user supplied value,
#                           eg. 'http(s)?://{domain}' to further check for
#                           a particular value. If and only if a re_parameters
#                           value is set then all values in the RE that are
#                           within curly brackets ({}) are replaced with the
#                           user supplied value. Only string values are
#                           supported for now.
#
# Example:
#
# windows_administrator_login:
#       description: Login information for Administrator in Windows EVTX files.
#       notes: Collect the SECURITY.EVTX log from a Windows machine.
#       query_string: data_type:"windows:evtx:record" AND event_identifier:4624
#       attribute: username
#       regular_expression: "^Administrator"

# ------------------------------------------------------------------------
windows_administrator_login:
  description: Login information for Administrator in Windows EVTX files.
  notes: Collect the SECURITY.EVTX log from a Windows machine.
  query_string: data_type:"windows:evtx:record" AND event_identifier:4624
  attribute: username
  regular_expression: "^Administrator"

windows_login:
  description: Login information in Windows EVTX files.
  notes: Collect the SECURITY.EVTX log from a Windows machine.
  query_string: data_type:"windows:evtx:record" AND event_identifier:4624

browser_history:
  description: Browser history information.
  notes: Collect browser history and parse using plaso or make source and url fields are set.
  query_string: source_short:"WEBHIST" OR source:"WEBHIST"
  attribute: url
  regular_expression: "https?://"

windows_event_log_specific_computer:
  description:
  notes: Collect
  query_string: data_type:"windows:evtx:record"
  attribute: computer_name
  regular_expression: "{computer_name}"
  re_flags: [IGNORECASE]
  re_parameters:
    - computer_name

windows_usb_devices_registry:
  description: List USB Devices based on registry
  notes: Collect the registry
  query_string: data_type:"windows:registry:key_value" AND "USBSTOR"

windows_usb_event_log:
  description: List USB related events
  notes: Filters out Mouse and Keyboard related events
  query_string: data_type:"windows:evtx:record" AND event_identifier:* AND usb NOT (UserPnp OR Kernel-Pnp) AND NOT ("USB Keyboard" OR "USB Optical Mouse")

windows_10_usb_storage_auditing_enabled:
  description: Checks on Windows 10 if USB Storage auditing is enabled.
  notes: https://www.eventsentry.com/kb/410
  query_string: key_path:SYSTEM\\CurrentControlSet\\Control\\Storage

windows_current_control_set:
  description: Get the current active control set
  notes: This is used to determine further interesting aspects in the registry.
  query_string: HKEY_LOCAL_MACHINE*System*Select
  attribute: values

windows_current_timezone_information:
  description: Get the current timezone information
  notes: In case there are multiple ControlSets, check for the active one.
  query_string: data_type:"windows:registry:timezone" AND TimeZoneInformation
  attribute: configuration

windows_users_reg:
  description: Shows user profiles on a windows system
  notes: StoredIdentities is showing a Windows 10 Account
  query_string: data_type:"windows:registry:key_value" AND (Domains\\Account\\Users\\Names OR Software\\Microsoft\\IdentityCRL\\StoredIdentities\\)

windows_network_history:
  description: Identifies networks a computer has been connected to.
  notes: location is depending on the Windows version
  query_string: data_type:"windows:registry:key_value" AND (NetworkList\\Signatures\\Unmanaged OR NetworkList\\Signatures\\Managed OR NetworkList\\Nla\\Cache)

windows_wlan_history_network_started:
  description:  Windows Wlan history network started
  notes: Wifi interface was started
  query_string: source_name:Microsoft-Windows-WLAN AND event_identifier:11000

windows_wlan_history_network_successful_connecting:
  description:  Windows Wlan network successful connecting
  notes: Wifi network was connected
  query_string: source_name:Microsoft-Windows-WLAN AND event_identifier:8001

windows_wlan_history_network_failed_connecting:
  description: Failed connection attempt
  notes: Wifi connection attempt failed
  query_string: source_name:Microsoft-Windows-WLAN AND event_identifier:8002

windows_wlan_history_network_disconnect:
  description: Disconnected connection
  notes: Wifi network disconnected
  query_string: source_name:Microsoft-Windows-WLAN AND event_identifier:8003

windows_local_account_created:
  description: A local account was created
  notes: https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4720
  query_string: event_identifier:4720

windows_rest_user_password:
  description: Attempt to reset a local user password
  notes: Might be a script or malicious activity
  query_string: data_type:"windows:evtx:record" AND source_name:"Microsoft-Windows-Security-Auditing" AND event_identifier:4724

windows_version:
  description: Get the Windows Version from Registry
  notes: https://www.gaijin.at/en/infos/windows-version-numbers
  query_string: data_type:"windows:registry:installation" AND HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion

windows_failed_logons_4625:
  description: An account failed to log on
  notes: See: https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4625 for more information.
  query_string: source_name:"Microsoft-Windows-Security-Auditing" AND event_identifier:4625

windows_successful_logon_4624:
  description: An successful logon
  query_string: source_name:"Microsoft-Windows-Security-Auditing" AND (event_identifier:4624 OR tag:logon_event)